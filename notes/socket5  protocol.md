## socket5 协议连接步骤

1. 客户端需要先发送请求来协商版本及认证方式
> ver + nmethods + methods

> NMETHODS是METHODS部分的长度
> METHODS是客户端支持的认证方式列表
```
0x00 不需要认证
0x01 GSSAPI
0x02 用户名、密码认证
0x03 - 0x7F由IANA分配（保留）
0x80 - 0xFE为私人方法保留
0xFF 无可接受的方法
```

2. 服务器从客户端提供的方法中选择一个并通过以下消息通知客户端
> ver + method

3. 认证结束后客户端就可以发送请求信息
> ver + cmd + rsv + atyp + dst addr + dst port

> CMD是SOCK的命令码
```
0x01表示CONNECT请求
0x02表示BIND请求
0x03表示UDP转发
```
> RSV 0x00，保留

> ATYP DST ADDR类型
```
0x01 IPv4地址，DST ADDR部分4字节长度
0x03域名，DST ADDR部分第一个字节为域名长度，DST ADDR剩余的内容为域名，没有\0结尾。
0x04 IPv6地址，16个字节长度。
```
> DST ADDR目的地址
> DST PROT网络字节序表示的目的端口

4. 服务器按以下格式回应客户端的请求

> ver + rep + rsv + atyp + bnd addr + bnd port

> REP应答字段
```
0x00表示成功
0x01普通SOCKS服务器连接失败
0x02现有规则不允许连接
0x03网络不可达
0x04主机不可达
0x05连接被拒
0x06 TTL超时
0x07不支持的命令
0x08不支持的地址类型
0x09 - 0xFF未定义
```
> BND ADDR服务器绑定的地址
> BND PROT网络字节序表示的服务器绑定的端口

## socket5 TCP 和 UDP 连接
1. tcp 连接
```
1.向服务器的1080端口建立tcp连接。
2.向服务器发送 05 01 00, 表示socket5，不需要认证的连接
3.如果接到 05 00 则是可以代理（服务器向客户发送）
4.发送 05 01 00 01 + 目的地址(4字节） +目的端口（2字节），目的地址和端口都是16进制码（不是字符串！！）。 例202.103.190.27:7201 则发送的信息为：05 01 00 01 CA
67 BE 1B 1C 21 (CA=202 67=103 BE=190 1B=27
1C21=7201)
5.接受服务器返回的自身地址和端口，连接完成
6.以后操作和直接与目的方进行TCP连接相同。
```
2. udp 连接
```
1.向服务器的1080端口建立udp连接
2.向服务器发送
05 01 00
3.如果接到 05 00 则是可以代理
4.发送 05 03 00 01 00 00 00 00 +
本地UDP端口（2字节）
5.服务器返回 05 00 00 01 +服务器地址+端口
6.需要申请方发送 00 00 00 01
+目的地址IP（4字节）+目的端口 +所要发送的信息
7.当有数据报返回时 向需要代理方发出00 00 00 01 +来源地址IP（4字节）+来源端口
+接受的信息
```

